# コードレビューチェックリスト

## 使い方

このチェックリストは、コードレビューの品質を保証するための包括的なガイドです。

### 対象者
- **開発者**: プルリクエスト作成前のセルフチェック
- **レビュアー**: レビュー時の確認項目
- **プロジェクトマネージャー**: 品質保証の最終確認

### 使用タイミング
1. **プルリクエスト作成前**: 開発者が全項目をセルフチェック
2. **レビュー時**: レビュアーが重点項目を確認
3. **マージ前**: 最終確認として使用

### チェック方法
- 該当する項目にチェックマーク ✓ を入れる
- 非該当の項目は N/A と記載
- 問題がある項目はコメントを追記

---

## 1. 基本チェック

### 1.1 コーディング規約準拠

- [ ] **命名規則準拠**: 変数はキャメルケース、定数は大文字+アンダースコア、クラスはパスカルケース
- [ ] **インデント**: スペース2つで統一
- [ ] **セミコロン付与**: すべての文末にセミコロンあり
- [ ] **行の長さ**: 80文字以内（例外: URL、長い文字列リテラル）
- [ ] **ESLintエラーなし**: `npm run lint`が成功
- [ ] **コンソールエラー・警告なし**: 開発環境で実行時エラーなし

### 1.2 ファイル構成

- [ ] **適切なディレクトリ配置**: functions/, src/, docs/の規則に従う
- [ ] **ファイル名が機能を表している**: 内容が名前から推測できる
- [ ] **Single Responsibility**: 1ファイル=1責務
- [ ] **ファイルサイズ適切**: 500行を超える場合は分割を検討

### 1.3 コメント・ドキュメント

- [ ] **20行以上の関数にJSDoc**: `@param`, `@returns`, `@throws`必須タグ完備
- [ ] **Cloud Functions全てにJSDoc**: エクスポートされるすべての関数にJSDoc
- [ ] **複雑なロジックにインラインコメント**: 正規表現、複雑な条件分岐など
- [ ] **TODOコメント適切**: 担当者、優先度、説明を明記
- [ ] **対応するdocs/ドキュメント更新済み**: 仕様変更時は設計書も更新

---

## 2. 機能実装チェック

### 2.1 要件充足

- [ ] **仕様通りに動作**: 要件定義・設計書の通りに実装
- [ ] **エッジケース考慮**: 空文字列、null、undefined、最大値など
- [ ] **エラーケース考慮**: ネットワークエラー、APIエラー、DB接続エラーなど
- [ ] **すべての環境で動作確認**: 開発、ステージング、本番環境

### 2.2 非同期処理

- [ ] **async/await使用**: Promiseチェーン未使用
- [ ] **try-catch-finallyでエラーハンドリング**: すべての非同期処理をラップ
- [ ] **必ずPromise/値を返す**: Firebase Functionsで返却必須
- [ ] **並列処理でPromise.all使用**: 独立した複数の非同期処理を並列実行
- [ ] **タイムアウト設定**: 長時間処理には適切なタイムアウト設定

### 2.3 エラーハンドリング

- [ ] **すべてのエラーケースをcatch**: try-catchで適切に処理
- [ ] **適切なHttpsError型**: `invalid-argument`, `internal`など適切に使用
- [ ] **エラーログに十分な情報**: text, targetLang, stack traceなど
- [ ] **ユーザーへの適切なエラーメッセージ**: 日本語で分かりやすく
- [ ] **エラー時のフォールバック処理**: 3層フォールバック戦略など

---

## 3. セキュリティチェック

### 3.1 入力バリデーション

- [ ] **全ての入力パラメータをバリデーション**: 型、存在、範囲をチェック
- [ ] **型チェック**: `typeof`, `instanceof`で型確認
- [ ] **範囲チェック**: 文字列長、数値範囲、配列長など
- [ ] **許可リスト方式（ホワイトリスト）**: 許可された値のみ受け付ける
- [ ] **SQLインジェクション対策**: Firestoreクエリでも注意

### 3.2 認証・認可

- [ ] **context.authで認証確認**: 必要な機能では認証チェック実装
- [ ] **権限チェック実装**: 管理者機能などで適切な権限確認
- [ ] **Firestore Security Rules設定済み**: コレクション単位でルール設定
- [ ] **APIキー・シークレットは環境変数化**: ハードコード禁止

### 3.3 データ保護

- [ ] **機密情報をログ出力していない**: パスワード、APIキーなど
- [ ] **パスワード等の平文保存なし**: ハッシュ化必須
- [ ] **XSS対策**: ユーザー入力のサニタイズ実施
- [ ] **CSRF対策**: 必要な箇所で実装

---

## 4. パフォーマンスチェック

### 4.1 レスポンスタイム

- [ ] **翻訳処理: 1秒以内（キャッシュヒット時）**
- [ ] **翻訳処理: 3秒以内（API呼び出し時）**
- [ ] **メニュー取得: 2秒以内**
- [ ] **注文作成: 2秒以内**
- [ ] **重い処理は非同期化・バックグラウンド化**

### 4.2 データベース最適化

- [ ] **不要なread/write操作なし**: 必要最小限のDB操作
- [ ] **適切なインデックス設定**: よく使うクエリにインデックス
- [ ] **N+1クエリ問題なし**: ループ内でのDB呼び出しを避ける
- [ ] **バッチ処理で複数操作を統合**: Firestore Batchを活用

### 4.3 キャッシュ活用

- [ ] **翻訳結果をキャッシュ（30日）**: translation_cacheコレクション活用
- [ ] **辞書データをメモリキャッシュ（5分）**: 頻繁なDB読み込み回避
- [ ] **重複API呼び出し防止**: キャッシュチェック優先
- [ ] **キャッシュヒット率50%以上**: 測定・モニタリング実施

### 4.4 リソース管理

- [ ] **不要な変数・オブジェクトなし**: メモリ効率化
- [ ] **メモリリークなし**: イベントリスナー適切に解除
- [ ] **画像サイズ最適化**: 必要に応じて圧縮・リサイズ
- [ ] **不要なインポートなし**: 未使用のライブラリを削除

---

## 5. Firebase Functions特有チェック

### 5.1 関数設定

- [ ] **リージョン指定**: `asia-northeast1`（東京）
- [ ] **タイムアウト設定**: 180秒推奨（翻訳処理）
- [ ] **メモリ設定**: 512MB推奨
- [ ] **maxInstances設定**: コスト管理のため10に制限

### 5.2 ログ出力

- [ ] **構造化ログ使用**: JSONオブジェクトで詳細情報
- [ ] **エラー時にスタックトレース出力**: `error.stack`を含める
- [ ] **機密情報をログに含めない**: APIキー、パスワードなど
- [ ] **console.log vs functions.logger適切に使用**: 環境に応じて選択

### 5.3 コスト管理

- [ ] **不要な関数呼び出しなし**: 最適化で呼び出し回数削減
- [ ] **キャッシュでAPI呼び出し削減**: DeepL APIの無料枠を考慮
- [ ] **バッチ処理で複数操作統合**: Firestoreの読み書き回数削減

---

## 6. 翻訳システム特有チェック

### 6.1 ハイブリッド翻訳

- [ ] **3層フォールバック実装**: Level 1(形態素解析+辞書+API) → Level 2(辞書+API) → Level 3(APIのみ)
- [ ] **キャッシュチェック優先**: 最初にtranslation_cacheを確認
- [ ] **専門用語抽出実装**: 辞書データから用語を検出
- [ ] **後処理補正実装**: 優先度1-2の用語を強制置換

### 6.2 辞書管理

- [ ] **辞書データ構造準拠**: `term_ja`, `term_en`, `term_zh`, `priority`フィールド
- [ ] **優先度順ソート**: priority値の昇順で処理
- [ ] **辞書キャッシュ実装（5分TTL）**: メモリ内キャッシュで高速化
- [ ] **辞書更新時の整合性**: カテゴリ、優先度が適切

### 6.3 翻訳精度

- [ ] **専門用語が正確に翻訳される**: 辞書登録済み用語のテスト
- [ ] **文脈に応じた適切な訳語**: 前後の文脈を考慮
- [ ] **誤訳がない**: テストケースで確認
- [ ] **翻訳精度90%以上（目標値）**: 専門用語50エントリで測定

---

## 7. QRコードシステム特有チェック

### 7.1 QRコードフォーマット

- [ ] **`{restaurantId}/{tableId}` 形式**: 正しいフォーマット
- [ ] **パース処理実装**: split('/')で分割・取得
- [ ] **バリデーション実装**: 形式チェック、存在確認

### 7.2 QRコード検証

- [ ] **Firestore存在確認実装**: restaurantsコレクション、tablesサブコレクションをチェック
- [ ] **テーブルステータスチェック**: `available` / `unavailable` 確認
- [ ] **エラーメッセージ適切**: 「テーブルが見つかりません」など分かりやすく

### 7.3 セキュリティ

- [ ] **QRコード偽装対策**: DB検証で実在するテーブルのみ許可
- [ ] **有効期限チェック**: 必要に応じて実装
- [ ] **不正なQRコードの拒否**: フォーマット違反を適切に処理

---

## 8. データベースチェック

### 8.1 Firestoreスキーマ

- [ ] **コレクション名規約準拠**: 複数形、小文字、アンダースコア区切り
- [ ] **フィールド名規約準拠**: 小文字、アンダースコア区切り
- [ ] **多言語フィールド準拠**: `name_ja`, `name_en`, `name_zh`形式
- [ ] **タイムスタンプ設定**: `created_at`, `updated_at`必須

### 8.2 データ整合性

- [ ] **必須フィールド全て設定**: ドキュメント作成時に必須項目を全て設定
- [ ] **リレーション整合性確保**: 外部キー参照が正しい
- [ ] **デフォルト値設定**: 必要なフィールドにデフォルト値
- [ ] **NULL/undefined考慮**: 存在しない可能性のあるフィールドを適切に処理

### 8.3 Security Rules

- [ ] **読み取り権限設定**: コレクション単位で適切な権限
- [ ] **書き込み権限設定**: 管理者のみ、認証ユーザーのみなど
- [ ] **バリデーションルール設定**: 必須フィールド、型チェックなど

---

## 9. React Native特有チェック

### 9.1 UI/UX

- [ ] **レスポンシブデザイン**: 複数画面サイズ（iPhone SE, Pro Max, iPad等）
- [ ] **ローディング表示実装**: 非同期処理中のスピナー表示
- [ ] **エラーメッセージ表示**: 分かりやすいエラー通知
- [ ] **多言語対応**: 日本語、英語、中国語で正しく表示

### 9.2 ナビゲーション

- [ ] **画面遷移スムーズ**: React Navigationで適切に実装
- [ ] **パラメータ受け渡し正常**: route.paramsで正しく取得
- [ ] **戻るボタン動作正常**: navigation.goBackが適切に機能

### 9.3 状態管理

- [ ] **useState/useEffect適切に使用**: React Hooksの正しい利用
- [ ] **不要な再レンダリングなし**: useMemo, useCallbackで最適化
- [ ] **メモリリークなし**: useEffectのクリーンアップ関数実装

---

## 10. テストチェック

### 10.1 単体テスト

- [ ] **主要関数にテスト実装**: translateText, createOrderなど
- [ ] **正常系テスト**: 期待通りの動作確認
- [ ] **異常系テスト**: エラー時の挙動確認
- [ ] **エッジケーステスト**: 空文字列、null、最大値など

### 10.2 統合テスト

- [ ] **Cloud Functions統合テスト**: 関数間の連携テスト
- [ ] **Firestore連携テスト**: DB読み書きの動作確認
- [ ] **外部API連携テスト**: DeepL APIとの連携テスト

### 10.3 E2Eテスト

- [ ] **主要画面のE2Eテスト**: QRスキャン→言語選択→メニュー→注文の流れ
- [ ] **QRコード読み取りテスト**: 実機でのカメラ動作確認
- [ ] **注文フローテスト**: エンドツーエンドの動作確認

### 10.4 翻訳精度テスト

- [ ] **専門用語50エントリテスト**: 辞書登録済み用語の翻訳精度
- [ ] **翻訳精度90%以上確認**: 目標値達成
- [ ] **フォールバック動作確認**: Level 1→2→3の切り替え動作

---

## 11. プロジェクト固有チェック

### 11.1 評価実験対応

- [ ] **留学生評価実験プロトコル準拠**: 15分/人の実験フロー
- [ ] **満足度4.0以上目標**: 5段階評価での目標設定
- [ ] **タスク完了率90%以上目標**: QRスキャン、言語選択、メニュー閲覧、注文実行

### 11.2 研究的価値

- [ ] **形態素解析実装（Kuromoji.js）**: 本研究の核心要素
- [ ] **学術的新規性確保**: 形態素解析×機械翻訳の融合
- [ ] **論文での主張可能な実装**: 従来手法比20%向上を示せる設計

---

## 12. 最終チェック

### 12.1 コミット前

- [ ] **全てのテスト通過**: Jest, E2Eテストなど
- [ ] **ビルドエラーなし**: `npm run build`が成功
- [ ] **コンソールエラー・警告なし**: 開発サーバーで確認
- [ ] **不要なコメントアウト削除**: 古いコード、デバッグコードなど
- [ ] **デバッグコード削除**: console.log、debugger文など

### 12.2 プルリクエスト前

- [ ] **コミットメッセージ適切**: 「[種別] 何を、なぜ」形式
- [ ] **対応するIssue番号記載**: #123など
- [ ] **設計資料（docs/）更新**: 仕様変更に応じたドキュメント更新
- [ ] **READMEに変更内容反映**: 必要な場合のみ

### 12.3 レビュー依頼時

- [ ] **プルリクエスト説明文記載**: 変更内容、目的、影響範囲
- [ ] **スクリーンショット添付**: UI変更の場合
- [ ] **動作確認方法記載**: レビュアーが確認しやすいように
- [ ] **関連設計資料リンク**: docs/配下のドキュメントへのリンク

---

## チェックリスト使用例

### プルリクエスト作成時

プルリクエストの説明文に以下のように記載してください:

```markdown
## レビューチェックリスト完了状況

### 基本チェック
- [x] コーディング規約準拠
- [x] ファイル構成適切
- [x] コメント・ドキュメント完備

### 機能実装チェック
- [x] 要件充足
- [x] 非同期処理適切
- [x] エラーハンドリング実装

### セキュリティチェック
- [x] 入力バリデーション実装
- [x] 認証・認可実装
- [x] データ保護対策済み

### 翻訳システム特有チェック
- [x] 3層フォールバック実装
- [x] 辞書管理適切
- [x] 翻訳精度テスト通過(92%)

### パフォーマンスチェック
- [x] レスポンスタイム目標達成
- [x] キャッシュヒット率55%

### 最終チェック
- [x] 全てのテスト通過
- [x] 設計資料更新
- [x] READMEに変更内容反映

**レビュー時の注意点**:
- 形態素解析部分の実装精度を重点的に確認してください
- DeepL APIエラー時のフォールバック動作を確認してください
- translation_cacheコレクションへの書き込みが正しく行われているか確認してください
```

---

## 付録

### A. 重点チェック項目（最小限）

時間がない場合、以下の項目を最優先でチェックしてください:

1. [ ] **コーディング規約準拠**: 命名、インデント、セミコロン
2. [ ] **エラーハンドリング実装**: try-catch、HttpsError
3. [ ] **入力バリデーション実装**: 型、範囲、許可リスト
4. [ ] **セキュリティ対策済み**: 環境変数、Security Rules
5. [ ] **テスト通過**: 単体テスト、統合テスト
6. [ ] **設計資料更新**: docs/配下のドキュメント

### B. 自動チェックツール

以下のツールを活用して自動チェックを実施してください:

| ツール | コマンド | チェック内容 |
|--------|---------|-------------|
| **ESLint** | `npm run lint` | コーディングスタイル |
| **Prettier** | `npm run format` | フォーマット |
| **Jest** | `npm test` | 単体テスト |
| **Firebase Emulator** | `firebase emulators:start` | ローカルテスト |

### C. 参考資料

- [CLAUDE.md](.claude/CLAUDE.md): コーディング規約詳細
- [docs/](../docs/): 各機能の設計資料
- [README.md](../README.md): プロジェクト全体概要
- [docs/translation_system_design.md](../docs/translation_system_design.md): 翻訳システム設計
- [docs/qr_code_design.md](../docs/qr_code_design.md): QRコード設計
- [docs/database_design.md](../docs/database_design.md): Firestore設計

### D. レビュアー向けガイドライン

#### レビューの優先順位

1. **セキュリティ**: 入力バリデーション、認証・認可、機密情報の扱い
2. **機能性**: 要件充足、エラーハンドリング、エッジケース
3. **パフォーマンス**: レスポンスタイム、キャッシュ活用、DB最適化
4. **保守性**: コメント、命名規則、コードの可読性
5. **スタイル**: インデント、セミコロン、行の長さ

#### レビューコメントのベストプラクティス

```markdown
# 良いレビューコメント例

## セキュリティの問題
**問題**: ユーザー入力のバリデーションが不足しています。
**理由**: 悪意のある入力でエラーやセキュリティリスクが発生する可能性があります。
**提案**:
\`\`\`javascript
if (!text || typeof text !== 'string' || text.length > 1000) {
  throw new functions.https.HttpsError('invalid-argument', 'textが不正です');
}
\`\`\`
**参照**: [CLAUDE.md セクション8.1](../CLAUDE.md#81-入力バリデーション必須項目)

## 改善提案
**提案**: キャッシュチェックを追加することでパフォーマンスが向上します。
**理由**: 翻訳APIの呼び出し回数を削減し、レスポンスタイムを改善できます。
**優先度**: 中
```

---

**最終更新**: 2024-12-09
**バージョン**: 1.0
**作成者**: プロジェクトチーム

このチェックリストは[CLAUDE.md](.claude/CLAUDE.md)のコーディング規約に基づいて作成されています。
